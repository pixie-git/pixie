# Production Docker Compose
#
# Usage: JWT_SECRET=your-secret docker compose -f docker-compose.prod.yml up -d --build
#
# Access: http://localhost:3080 (app + API + Swagger via nginx proxy)
#
# For Portainer + NPM: proxy app.example.com -> pixie-client:3080 (enable WebSocket)
#
# See DEPLOYMENT.md for full documentation

services:
  mongo:
    image: mongo:7
    container_name: pixie-mongo
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db
    networks:
      - pixie-net
    # NOT exposed externally - only accessible within Docker network

  mongo-express:
    image: mongo-express:latest
    container_name: pixie-mongo-express
    restart: unless-stopped
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongo:27017
      ME_CONFIG_BASICAUTH_USERNAME: ${ME_USERNAME:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${ME_PASSWORD:-changeme}
    ports:
      - "${ME_PORT:-8081}:8081"
    depends_on:
      - mongo
    networks:
      - pixie-net

  server:
    build:
      context: ./server
      target: production-stage
    image: pixie-server:latest
    container_name: pixie-server
    restart: unless-stopped
    environment:
      PORT: 3000
      MONGO_URI: mongodb://mongo:27017/pixie
      CLIENT_ORIGIN: ${CLIENT_ORIGIN:-*}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      NODE_ENV: production
    depends_on:
      - mongo
    networks:
      - pixie-net

  client:
    build:
      context: ./client
      target: production-stage
      args:
        VITE_API_URL: ${VITE_API_URL:-}
    image: pixie-client:latest
    container_name: pixie-client
    restart: unless-stopped
    ports:
      - "${CLIENT_PORT:-3080}:80"
    networks:
      - pixie-net

volumes:
  mongo-data:

networks:
  pixie-net:
